<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Star Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: 'Inter', sans-serif; }
        canvas { touch-action: none; cursor: grab; background-color: #1f2937; border-radius: 0.5rem; }
        canvas:active { cursor: grabbing; }
        .hidden { display: none; }
        input:focus {
            box-shadow: 0 0 0 2px #4f46e5;
        }
        .logo-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }
        .logo-container img {
            width: 100px;
            height: 100px;
            z-index: 1;
            animation: float 6s ease-in-out infinite;
        }
        .logo-container::before {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.15), transparent 70%);
            border-radius: 50%;
            z-index: 0;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
</head>
<body class="h-screen antialiased overflow-hidden">

    <div id="login-view" class="flex items-center justify-center h-full">
        <div class="w-full max-w-md p-8 space-y-8 bg-gray-900 rounded-lg shadow-lg">
            <div class="logo-container"><img src="/logo.png" alt="Galactic Star Map Logo"></div>
            <div><h2 class="text-3xl font-extrabold text-center text-white">Sign In</h2><p class="mt-2 text-sm text-center text-gray-400">to view your star map</p></div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px"><input id="username" name="username" type="text" required class="relative block w-full px-3 py-2 text-white bg-gray-700 border border-gray-600 rounded-t-md placeholder-gray-400 focus:outline-none focus:ring-indigo-500" placeholder="Username"><input id="password" name="password" type="password" required class="relative block w-full px-3 py-2 text-white bg-gray-700 border border-gray-600 rounded-b-md placeholder-gray-400 focus:outline-none focus:ring-indigo-500" placeholder="Password"></div>
                <div><button type="submit" class="w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Sign in</button></div>
                <p id="login-error" class="text-sm text-center text-red-400 h-4" aria-live="assertive"></p>
            </form>
            <div class="text-sm text-center text-gray-400">
                <p>Don't have an account? <button id="show-register-view-button" class="font-medium text-indigo-400 hover:text-indigo-300">Register</button></p>
                <p class="mt-2">Need help? <a href="/guide.html" class="font-medium text-indigo-400 hover:text-indigo-300">Read the User Guide</a></p>
            </div>
        </div>
    </div>
    <div id="register-view" class="hidden flex items-center justify-center h-full">
        <div class="w-full max-w-md p-8 space-y-8 bg-gray-900 rounded-lg shadow-lg">
            <div class="logo-container"><img src="/logo.png" alt="Galactic Star Map Logo"></div>
            <div><h2 class="text-3xl font-extrabold text-center text-white">Create Account</h2><p class="mt-2 text-sm text-center text-gray-400">to start building your map</p></div>
            <form id="register-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <input id="register-username" name="username" type="text" required class="w-full px-3 py-2 text-white bg-gray-700 border border-gray-600 rounded-t-md placeholder-gray-400 focus:outline-none focus:ring-indigo-500" placeholder="Username">
                    <input id="register-password" name="password" type="password" required class="w-full px-3 py-2 text-white bg-gray-700 border border-gray-600 placeholder-gray-400 focus:outline-none focus:ring-indigo-500" placeholder="Password">
                    <input id="register-api-key" name="api_key" type="text" required class="w-full px-3 py-2 text-white bg-gray-700 border border-gray-600 rounded-b-md placeholder-gray-400 focus:outline-none focus:ring-indigo-500" placeholder="Game API Key">
                </div>
                <p class="text-xs text-gray-400 text-center px-2">Please be aware that using an API key on any third-party service carries inherent security risks, even with encryption.</p>
                <div><button type="submit" class="w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Create Account</button></div>
                 <p id="register-error" class="text-sm text-center text-red-400 h-4" aria-live="assertive"></p>
            </form>
            <div class="text-sm text-center text-gray-400">
                <p>Already have an account? <button id="show-login-view-button" class="font-medium text-indigo-400 hover:text-indigo-300">Sign In</button></p>
                <p class="mt-2">Need help? <a href="/guide.html" class="font-medium text-indigo-400 hover:text-indigo-300">Read the User Guide</a></p>
            </div>
        </div>
    </div>
    <div id="profile-view" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="w-full max-w-md p-8 space-y-6 bg-gray-900 rounded-lg shadow-lg">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-white">Manage Profile</h2><button id="close-profile-button" class="text-gray-400 hover:text-white">&times;</button></div>
            <form id="profile-form" class="space-y-4">
                <div><label for="api-key-input" class="block text-sm font-medium text-gray-300">API Key</label><input id="api-key-input" type="text" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-indigo-500" placeholder="Enter your game API key"></div>
                <div><label for="new-password-input" class="block text-sm font-medium text-gray-300">New Password (optional)</label><input id="new-password-input" type="password" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-indigo-500" placeholder="Leave blank to keep current password"></div>
                <div><button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Save Changes</button></div>
                <p id="profile-status" class="text-sm text-center h-4" aria-live="assertive"></p>
            </form>
        </div>
    </div>

    <div id="map-view" class="hidden flex h-screen overflow-hidden">
        <aside id="side-panel" class="absolute top-0 left-0 z-20 h-full w-full max-w-sm transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:max-w-xs md:translate-x-0 lg:max-w-sm bg-gray-900 p-6 flex-shrink-0 overflow-y-auto">
            <div class="space-y-6">
                <header class="flex items-center justify-between">
                    <div><h1 class="text-2xl font-bold text-white">Galactic Star Map</h1><p id="welcome-message" class="text-sm text-gray-400"></p></div>
                    <div id="user-controls" class="flex space-x-2">
                        <a href="/guide.html" class="px-3 py-1 text-sm font-medium text-white bg-gray-600 rounded-md hover:bg-gray-700">Guide</a>
                        <button id="profile-button" class="px-3 py-1 text-sm font-medium text-white bg-gray-600 rounded-md hover:bg-gray-700">Profile</button>
                        <button id="logout-button" class="px-3 py-1 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Logout</button>
                    </div>
                </header>
                <div id="sync-container" class="border-t border-b border-gray-700 py-4 space-y-3">
                    <button id="sync-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Sync Map Data</button>
                    <p id="sync-status" class="text-sm text-center text-gray-400 mt-2 h-4" aria-live="assertive"></p>
                </div>
                <form id="route-form" class="space-y-4">
                    <input type="text" id="start-system-input" list="system-list" class="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-indigo-500" placeholder="Start System or #Position...">
                    <input type="text" id="end-system-input" list="system-list" class="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none focus:ring-indigo-500" placeholder="End System or #Position...">
                    <datalist id="system-list"></datalist>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Find Shortest Path</button>
                </form>
                <div id="route-details" aria-live="polite" class="space-y-2"></div>
                <div class="border-t border-gray-700 pt-4 space-y-2" aria-hidden="true">
                    <h3 class="text-lg font-semibold text-white">Display Options</h3>
                    <div class="flex items-center">
                        <input id="toggle-all-catapults" type="checkbox" checked class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-indigo-600 focus:ring-indigo-500">
                        <label for="toggle-all-catapults" class="ml-2 block text-sm text-gray-300">Show All Catapult Ranges</label>
                    </div>
                    <div class="flex items-center">
                        <input id="toggle-unclaimed-names" type="checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-indigo-600 focus:ring-indigo-500">
                        <label for="toggle-unclaimed-names" class="ml-2 block text-sm text-gray-300">Show Unclaimed Names</label>
                    </div>
                    <p class="text-xs text-gray-500">Click a system to highlight its range. Long-press to toggle.</p>
                    <button id="reset-view-button" class="mt-2 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md text-sm">Reset View</button>
                </div>
            </div>
        </aside>

        <main class="relative flex-grow flex items-center justify-center">
            <button id="menu-button" class="md:hidden absolute top-4 left-4 z-30 p-2 bg-gray-800 text-white rounded-md" aria-controls="side-panel" aria-expanded="false">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <button id="center-me-button" class="absolute bottom-4 right-4 z-10 p-2 bg-gray-800 text-white rounded-full shadow-lg" title="Center on latest system">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
            <canvas id="map-canvas" class="w-full h-full"></canvas>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let systems = {}; let wormholes = []; let calculatedPathNodes = []; let viewTransform = { scale: 1, translateX: 0, translateY: 0 }; 
        let isMouseDown = false; let isDragging = false; let dragStartPos = { x: 0, y: 0 }; let lastDragPosition = {x:0, y:0};
        const SPIRAL_TIGHTNESS = 0.1; const SPIRAL_SCALE = 50;
        let showAllCatapults = true; let toggledCatapultIds = new Set();
        let activeRouteInput = null;
        let hoveredSystem = null;
        let showUnclaimedNames = false;
        let highlightedCatapultSystemId = null;
        let longPressTimer; let initialTouchDistance = null;

        const dom = { 
            loginView: document.getElementById('login-view'), mapView: document.getElementById('map-view'), registerView: document.getElementById('register-view'), 
            loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), profileView: document.getElementById('profile-view'), 
            canvas: document.getElementById('map-canvas'), ctx: document.getElementById('map-canvas').getContext('2d'), loginError: document.getElementById('login-error'), 
            logoutButton: document.getElementById('logout-button'), welcomeMessage: document.getElementById('welcome-message'), 
            syncContainer: document.getElementById('sync-container'), syncButton: document.getElementById('sync-button'), syncStatus: document.getElementById('sync-status'), 
            routeForm: document.getElementById('route-form'), startSystemInput: document.getElementById('start-system-input'), endSystemInput: document.getElementById('end-system-input'), 
            systemDataList: document.getElementById('system-list'), routeDetailsContainer: document.getElementById('route-details'), 
            profileButton: document.getElementById('profile-button'), closeProfileButton: document.getElementById('close-profile-button'), profileForm: document.getElementById('profile-form'), 
            apiKeyInput: document.getElementById('api-key-input'), newPasswordInput: document.getElementById('new-password-input'), profileStatus: document.getElementById('profile-status'), 
            registerError: document.getElementById('register-error'), showRegisterViewButton: document.getElementById('show-register-view-button'), showLoginViewButton: document.getElementById('show-login-view-button'), 
            toggleAllCatapults: document.getElementById('toggle-all-catapults'), userControls: document.getElementById('user-controls'), 
            resetViewButton: document.getElementById('reset-view-button'), toggleUnclaimedNames: document.getElementById('toggle-unclaimed-names'),
            sidePanel: document.getElementById('side-panel'),
            menuButton: document.getElementById('menu-button'),
            centerMeButton: document.getElementById('center-me-button')
        };

        const apiFetch = (url, options = {}) => { options.credentials = 'include'; return fetch(url, options); };
        const handleLogin = async (e) => { e.preventDefault(); const r=await apiFetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:dom.loginForm.username.value,password:dom.loginForm.password.value})}); const d=await r.json(); if(r.ok)showMapView(d.username, d.is_admin, d.is_developer); else dom.loginError.textContent=d.message||'Login failed.'; };
        const handleRegister = async (e) => { e.preventDefault(); const p={username:dom.registerForm.username.value,password:dom.registerForm.password.value,api_key:dom.registerForm.api_key.value}; const r=await apiFetch('/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)}); const d=await r.json(); if(r.ok)showMapView(d.username, d.is_admin, d.is_developer, true); else dom.registerError.textContent=d.message||'Registration failed.'; };
        const handleLogout = async () => { await apiFetch('/logout', { method: 'POST' }); localStorage.removeItem('mapViewTransform'); showLoginView(); };
        const checkLoginStatus = async () => { const r=await apiFetch('/status'); const d=await r.json(); if(d.logged_in)showMapView(d.username, d.is_admin, d.is_developer); else showLoginView(); };
        const handleSync = async () => { dom.syncStatus.textContent = 'Syncing...'; dom.syncButton.disabled = true; try { const r=await apiFetch('/api/sync',{method:'POST'}); const d=await r.json(); dom.syncStatus.textContent = d.message; if (r.ok) await fetchMapData(false); } catch (e) { dom.syncStatus.textContent = 'Error: Could not connect.'; } finally { dom.syncButton.disabled = false; setTimeout(() => { dom.syncStatus.textContent = ''; }, 7000); } };
        const openProfile = async () => { dom.profileStatus.textContent = ''; dom.newPasswordInput.value = ''; const r=await apiFetch('/api/profile'); const d=await r.json(); dom.apiKeyInput.value = d.api_key_set ? '(Key is set and encrypted)' : ''; dom.apiKeyInput.placeholder = d.api_key_set ? 'Enter a new key to overwrite' : 'Enter your game API key'; dom.profileView.classList.remove('hidden'); };
        const closeProfile = () => dom.profileView.classList.add('hidden');
        const handleProfileUpdate = async (e) => { e.preventDefault(); dom.profileStatus.textContent = 'Saving...'; const p={}; if (dom.apiKeyInput.value && dom.apiKeyInput.value !== '(Key is set and encrypted)') p.api_key = dom.apiKeyInput.value; if (dom.newPasswordInput.value) p.password = dom.newPasswordInput.value; const r=await apiFetch('/api/profile',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)}); const d=await r.json(); dom.profileStatus.textContent = d.message; setTimeout(closeProfile, 2000); };
        async function fetchMapData(shouldFit = true) { try {const r = await apiFetch('/api/systems'); if (!r.ok) { if (r.status === 401) handleLogout(); return; } const d = await r.json(); systems = d.systems; wormholes = d.wormholes; populateDataList(); if (shouldFit) { fitMapToView(); } drawMap();} catch (e) { console.error("Failed to fetch or draw map data:", e); } }
        async function findPath(startId, endId) { const r = await apiFetch('/api/path', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ start_id: startId, end_id: endId }), }); displayPathResults(await r.json()); }

        function showLoginView() { dom.mapView.classList.add('hidden'); dom.registerView.classList.add('hidden'); dom.loginView.classList.remove('hidden'); }
        function showRegisterView() { dom.mapView.classList.add('hidden'); dom.loginView.classList.add('hidden'); dom.registerView.classList.remove('hidden'); }
        function showMapView(username, isAdmin, isDeveloper, isNewRegistration = false) {
            dom.loginView.classList.add('hidden'); dom.registerView.classList.add('hidden'); dom.mapView.classList.remove('hidden');
            dom.welcomeMessage.textContent = `Welcome, ${username}`;
            let adminBtn = document.getElementById('admin-button');
            if (isAdmin && !adminBtn) { adminBtn = document.createElement('a'); adminBtn.id = 'admin-button'; adminBtn.href = '/admin'; adminBtn.textContent = 'Admin'; adminBtn.className = 'px-3 py-1 text-sm font-medium text-white bg-purple-600 rounded-md hover:bg-purple-700'; dom.userControls.prepend(adminBtn); } 
            else if (!isAdmin && adminBtn) { adminBtn.remove(); }
            if (isDeveloper) { dom.syncContainer.classList.add('hidden'); } else { dom.syncContainer.classList.remove('hidden'); }
            
            resizeCanvas(); 

            if (!isNewRegistration) {
                const savedView = localStorage.getItem('mapViewTransform');
                if (savedView) { viewTransform = JSON.parse(savedView); fetchMapData(false); } 
                else { fetchMapData(true); }
            } else {
                drawMap();
            }
        }
        function populateDataList() {
            dom.systemDataList.innerHTML = '';
            const options = new Set();
            Object.values(systems).forEach(s => {
                options.add(s.name);
                if (s.position) { options.add(`#${s.position}`); }
            });
            Array.from(options).sort().forEach(val => { const o = document.createElement('option'); o.value = val; dom.systemDataList.appendChild(o); });
        }
        
        function displayPathResults(result) {
            dom.routeDetailsContainer.innerHTML = '';
            calculatedPathNodes = result.path || [];

            const allNodes = {};
            calculatedPathNodes.forEach(p => allNodes[p.id] = p);

            const startName = dom.startSystemInput.value;
            const endName = dom.endSystemInput.value;
            dom.startSystemInput.value = '';
            dom.endSystemInput.value = '';
            
            if (result.simple_path && result.simple_path.length > 0 && result.distance != null) {
                let html = `<div class="flex justify-between items-center"><h2 class="text-lg font-semibold text-white">Route: ${startName} to ${endName}</h2><button id="clear-route-button" class="text-sm text-gray-400 hover:text-white focus:outline-none">&times; Clear</button></div><p class="text-sm text-gray-400">Total Distance: ${result.distance.toFixed(2)}</p><ol class="mt-2 space-y-2 text-sm">`;
                
                const getDisplayName = (node) => {
                    if (!node) return 'Unknown';
                    if (node.name.startsWith("System ")) {
                        return `#${node.position}`;
                    }
                    return node.name;
                };

                html += `<li class="text-gray-300">1. Start at: <span class="font-semibold text-white">${getDisplayName(allNodes[result.simple_path[0].from_id])}</span></li>`;
                result.simple_path.forEach((leg, index) => { 
                    const travelMethod = leg.method.charAt(0).toUpperCase() + leg.method.slice(1); 
                    let color = 'text-amber-400'; 
                    if (leg.method === 'wormhole') color = 'text-red-400'; 
                    if (leg.method === 'catapult') color = 'text-lime-400'; 
                    html += `<li class="text-gray-300">${index + 2}. Travel via <span class="font-semibold ${color}">${travelMethod}</span> to <span class="font-semibold text-white">${getDisplayName(allNodes[leg.to_id])}</span></li>`; 
                });
                html += `</ol>`; 
                dom.routeDetailsContainer.innerHTML = html;
            } else { dom.routeDetailsContainer.innerHTML = `<h2 class="text-lg font-semibold text-white">No Route Found</h2><p class="text-yellow-400">A path could not be found between ${startName} and ${endName}.</p>`; }
            drawMap();
        }

        function centerOnMyLocation() {
            if (Object.keys(systems).length === 0) return;
            
            let latestSystem = null;
            let maxPosition = -Infinity;
            for (const system of Object.values(systems)) {
                if (system.position > maxPosition) {
                    maxPosition = system.position;
                    latestSystem = system;
                }
            }

            if (latestSystem) {
                viewTransform.scale = 0.8;
                viewTransform.translateX = (dom.canvas.width / 2) - (latestSystem.x * viewTransform.scale);
                viewTransform.translateY = (dom.canvas.height / 2) - (latestSystem.y * viewTransform.scale);
                drawMap();
                localStorage.setItem('mapViewTransform', JSON.stringify(viewTransform));
            }
        }
        
        function toggleSidePanel() {
            const isExpanded = dom.menuButton.getAttribute('aria-expanded') === 'true';
            dom.sidePanel.classList.toggle('-translate-x-full');
            dom.menuButton.setAttribute('aria-expanded', !isExpanded);
        }

        function clearRouteDisplay() { calculatedPathNodes = []; dom.routeDetailsContainer.innerHTML = ''; dom.startSystemInput.value = ''; dom.endSystemInput.value = ''; drawMap(); }
        function resizeCanvas() { if(dom.canvas.parentElement.clientWidth > 0){ dom.canvas.width = dom.canvas.clientWidth; dom.canvas.height = dom.canvas.clientHeight; if(dom.canvas.width > 0) drawMap(); } }
        function fitMapToView() { if (Object.keys(systems).length === 0) return; let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity; Object.values(systems).forEach(s => { minX=Math.min(minX,s.x); maxX=Math.max(maxX,s.x); minY=Math.min(minY,s.y); maxY=Math.max(maxY,s.y); }); const mapW=maxX-minX, mapH=maxY-minY, mapCX=minX+mapW/2, mapCY=minY+mapH/2; const scale=Math.min(dom.canvas.width/(mapW*1.2), dom.canvas.height/(mapH*1.2))||1; viewTransform = { scale, translateX: (dom.canvas.width/2)-(mapCX*scale), translateY: (dom.canvas.height/2)-(mapCY*scale) }; localStorage.setItem('mapViewTransform', JSON.stringify(viewTransform));}
        const getSpiralPoint = (pos) => { const a=SPIRAL_TIGHTNESS, r=pos*SPIRAL_SCALE/1000; return { x: r*Math.cos(pos*a), y: r*Math.sin(pos*a) }; };
        
        function drawMap() {
            if(!dom.canvas.width || !dom.ctx) return; const ctx = dom.ctx;
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0,0,dom.canvas.width,dom.canvas.height);
            ctx.save();
            ctx.translate(viewTransform.translateX, viewTransform.translateY);
            ctx.scale(viewTransform.scale, viewTransform.scale);
            if(Object.keys(systems).length > 0){ let maxPos=Math.max(...Object.values(systems).filter(s => s.position).map(s=>s.position)); if(maxPos>0){ ctx.strokeStyle='rgba(75,85,99,0.2)';ctx.lineWidth=1/viewTransform.scale;ctx.beginPath();const s=1;ctx.moveTo(0,0);for(let p=s;p<=maxPos*1.1;p+=s)ctx.lineTo(getSpiralPoint(p).x,getSpiralPoint(p).y);ctx.stroke();}}
            Object.values(systems).forEach(sys => { 
                if (typeof sys.position !== 'number' || !sys.catapult_radius || sys.catapult_radius <= 0) return;
                const isToggled = toggledCatapultIds.has(String(sys.id));
                if (showAllCatapults ^ isToggled) {
                    let rangeColor = 'rgba(132, 204, 22, 0.3)';
                    if (highlightedCatapultSystemId !== null) { rangeColor = (sys.id === highlightedCatapultSystemId) ? 'rgba(163, 230, 57, 0.9)' : 'rgba(132, 204, 22, 0.05)'; }
                    ctx.strokeStyle = rangeColor; ctx.lineWidth = 2 / viewTransform.scale;
                    const startPos = sys.position - sys.catapult_radius; const endPos = sys.position + sys.catapult_radius;
                    const step = 1; 
                    ctx.beginPath(); ctx.moveTo(getSpiralPoint(startPos).x, getSpiralPoint(startPos).y);
                    for (let pos = startPos + step; pos < endPos; pos += step) { ctx.lineTo(getSpiralPoint(pos).x, getSpiralPoint(pos).y); }
                    ctx.lineTo(getSpiralPoint(endPos).x, getSpiralPoint(endPos).y); ctx.stroke();
                }
            });
            ctx.strokeStyle = 'rgba(239, 68, 68, 0.4)'; ctx.lineWidth = 1 / viewTransform.scale; ctx.setLineDash([5 / viewTransform.scale, 5 / viewTransform.scale]);
            wormholes.forEach(wh => { const sA=systems[wh[0]], sB=systems[wh[1]]; if (sA && sB) { ctx.beginPath(); ctx.moveTo(sA.x, sA.y); ctx.lineTo(sB.x, sB.y); ctx.stroke(); } });
            ctx.setLineDash([]);
            
            const calculatedPathIds = new Set(calculatedPathNodes.map(p => p.id));
            if (calculatedPathNodes.length > 1) {
                for (let i = 0; i < calculatedPathNodes.length - 1; i++) {
                    const sA = calculatedPathNodes[i];
                    const sB = calculatedPathNodes[i + 1];
                    const isKnownSystemA = !sA.id.toString().startsWith('virtual');
                    const isKnownSystemB = !sB.id.toString().startsWith('virtual');
                    const isWormhole = isKnownSystemA && isKnownSystemB && new Set(wormholes.map(wh => `${Math.min(wh[0],wh[1])}-${Math.max(wh[0],wh[1])}`)).has(`${Math.min(sA.id,sB.id)}-${Math.max(sA.id,sB.id)}`);
                    const isCatapult = isKnownSystemA && isKnownSystemB && systems[sA.id]?.catapult_radius > 0 && Math.abs(sA.position - sB.position) <= systems[sA.id].catapult_radius;
                    if (isWormhole) { ctx.strokeStyle='#ef4444'; ctx.lineWidth=3/viewTransform.scale; ctx.beginPath(); ctx.moveTo(sA.x, sA.y); ctx.lineTo(sB.x, sB.y); ctx.stroke(); } 
                    else if (isCatapult) { ctx.strokeStyle='#a3e635'; ctx.lineWidth=3/viewTransform.scale; ctx.beginPath(); ctx.moveTo(sA.x, sA.y); ctx.lineTo(sB.x, sB.y); ctx.stroke(); } 
                    else { 
                        ctx.strokeStyle='#f59e0b'; ctx.lineWidth=3/viewTransform.scale;
                        const s=1; ctx.beginPath(); ctx.moveTo(getSpiralPoint(sA.position).x,getSpiralPoint(sA.position).y); for (let j=1;j<=Math.floor(Math.abs(sB.position-sA.position)/s);j++)ctx.lineTo(getSpiralPoint(sA.position+(j*s*Math.sign(sB.position-sA.position))).x,getSpiralPoint(sA.position+(j*s*Math.sign(sB.position-sA.position))).y); ctx.lineTo(getSpiralPoint(sB.position).x,getSpiralPoint(sB.position).y);ctx.stroke();
                    }
                }
            }
            
            Object.values(systems).forEach(sys => {
                if (typeof sys.x !== 'number' || typeof sys.y !== 'number') { return; }
                const isOnPath = calculatedPathIds.has(String(sys.id));
                const isHovered = hoveredSystem && hoveredSystem.id === sys.id;
                ctx.fillStyle = isOnPath ? '#f59e0b' : '#38bdf8';
                ctx.beginPath();
                ctx.arc(sys.x, sys.y, (isOnPath || isHovered ? 6 : 4) / viewTransform.scale, 0, Math.PI * 2);
                ctx.fill();
            });

            calculatedPathNodes.forEach(node => {
                if (node.id.toString().startsWith('virtual')) {
                    const size = 8 / viewTransform.scale;
                    ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 2 / viewTransform.scale;
                    ctx.beginPath();
                    ctx.moveTo(node.x - size, node.y - size); ctx.lineTo(node.x + size, node.y + size);
                    ctx.moveTo(node.x + size, node.y - size); ctx.lineTo(node.x - size, node.y + size);
                    ctx.stroke();
                }
            });

            Object.values(systems).forEach(sys => {
                if (typeof sys.x !== 'number' || typeof sys.y !== 'number') return;
                const isOnPath = calculatedPathIds.has(String(sys.id));
                const isHovered = hoveredSystem && hoveredSystem.id === sys.id;
                
                let labelText = sys.name;
                if (sys.name.startsWith("System ") && typeof sys.position === 'number') { labelText = `#${sys.position}`; }
                const isDefaultName = labelText.startsWith("#");
                let shouldShowLabel = (isOnPath || isHovered || viewTransform.scale > 0.8);
                if (isDefaultName && !showUnclaimedNames && !isOnPath && !isHovered) { shouldShowLabel = false; }

                if (shouldShowLabel) {
                    ctx.fillStyle = (isOnPath || isHovered) ? '#ffffff' : '#e5e7eb';
                    ctx.font = `${(isOnPath || isHovered ? 12 : 10) / viewTransform.scale}px Inter`;
                    ctx.textAlign = 'center';
                    ctx.fillText(labelText, sys.x, sys.y - ((isOnPath || isHovered ? 10 : 8) / viewTransform.scale));
                }
            });

            calculatedPathNodes.forEach(node => {
                if (node.id.toString().startsWith('virtual')) {
                    const size = 8 / viewTransform.scale;
                    ctx.fillStyle = '#ffffff';
                    ctx.font = `${12 / viewTransform.scale}px Inter`;
                    ctx.textAlign = 'center';
                    ctx.fillText(node.name, node.x, node.y - (size + 4 / viewTransform.scale));
                }
            });

            ctx.restore();
        }
        function handleToggleAllCatapults(e) { showAllCatapults = e.target.checked; toggledCatapultIds.clear(); drawMap(); }
        function handleToggleUnclaimedNames(e) { showUnclaimedNames = e.target.checked; drawMap(); }
        function handleResetView() { fitMapToView(); drawMap(); }

        function getEventCoordinates(e) {
            const rect = dom.canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
            }
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function onInteractionStart(e) {
            isMouseDown = true; isDragging = false;
            const coords = getEventCoordinates(e);
            dragStartPos = { x: coords.x, y: coords.y };
            lastDragPosition = { x: coords.x, y: coords.y };
            
            clearTimeout(longPressTimer);
            longPressTimer = setTimeout(() => {
                if (!isDragging && hoveredSystem && hoveredSystem.catapult_radius > 0) {
                    const systemId = String(hoveredSystem.id);
                    if (toggledCatapultIds.has(systemId)) { toggledCatapultIds.delete(systemId); } 
                    else { toggledCatapultIds.add(systemId); }
                    drawMap();
                }
            }, 500);
        }

        function onInteractionMove(e) {
            e.preventDefault();
            const coords = getEventCoordinates(e);
            const worldX = (coords.x - viewTransform.translateX) / viewTransform.scale;
            const worldY = (coords.y - viewTransform.translateY) / viewTransform.scale;
            
            let currentlyHovering = null;
            for (const system of Object.values(systems)) {
                if (typeof system.x !== 'number' || typeof system.y !== 'number') continue;
                const dx = worldX - system.x; const dy = worldY - system.y;
                if (Math.sqrt(dx * dx + dy * dy) < (10 / viewTransform.scale)) {
                    currentlyHovering = system; break;
                }
            }
            if (hoveredSystem !== currentlyHovering) { hoveredSystem = currentlyHovering; drawMap(); }

            if (e.touches && e.touches.length === 2) {
                isDragging = false;
                const t1 = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                const t2 = { x: e.touches[1].clientX, y: e.touches[1].clientY };
                const dist = Math.hypot(t1.x - t2.x, t1.y - t2.y);
                if (initialTouchDistance) {
                    const scaleFactor = dist / initialTouchDistance;
                    const midX = (t1.x + t2.x) / 2 - dom.canvas.offsetLeft;
                    const midY = (t1.y + t2.y) / 2 - dom.canvas.offsetTop;
                    const worldMidX = (midX - viewTransform.translateX) / viewTransform.scale;
                    const worldMidY = (midY - viewTransform.translateY) / viewTransform.scale;
                    viewTransform.scale *= scaleFactor;
                    viewTransform.translateX = midX - worldMidX * viewTransform.scale;
                    viewTransform.translateY = midY - worldMidY * viewTransform.scale;
                    drawMap();
                }
                initialTouchDistance = dist;
                return;
            }

            let cursorStyle = hoveredSystem ? 'pointer' : 'grab';
            if (isMouseDown) {
                clearTimeout(longPressTimer);
                if (!isDragging && (Math.abs(coords.x - dragStartPos.x) > 5 || Math.abs(coords.y - dragStartPos.y) > 5)) {
                    isDragging = true;
                }
                if (isDragging) {
                    cursorStyle = 'grabbing';
                    const dx = coords.x - lastDragPosition.x;
                    const dy = coords.y - lastDragPosition.y;
                    viewTransform.translateX += dx;
                    viewTransform.translateY += dy;
                    lastDragPosition = { x: coords.x, y: coords.y };
                    drawMap();
                }
            } else {
                dom.canvas.style.cursor = cursorStyle;
            }
        }
        
        function onInteractionEnd(e) {
            clearTimeout(longPressTimer);
            if (!isDragging) {
                if (hoveredSystem) {
                    if (e.shiftKey) {
                         if (hoveredSystem.catapult_radius > 0) {
                            const systemId = String(hoveredSystem.id);
                            if (toggledCatapultIds.has(systemId)) { toggledCatapultIds.delete(systemId); } 
                            else { toggledCatapultIds.add(systemId); }
                        }
                    } else if (activeRouteInput) {
                        activeRouteInput.value = hoveredSystem.name;
                        if (activeRouteInput === dom.startSystemInput) { dom.endSystemInput.focus(); } 
                        else { dom.routeForm.querySelector('button[type="submit"]').focus(); }
                    }
                    highlightedCatapultSystemId = hoveredSystem.id;
                } else {
                    highlightedCatapultSystemId = null;
                }
                drawMap();
            }
            isMouseDown = false;
            isDragging = false;
            initialTouchDistance = null;
            dom.canvas.style.cursor = hoveredSystem ? 'pointer' : 'grab';
        }

        function setupEventListeners() {
            window.addEventListener('resize', resizeCanvas);
            dom.loginForm.addEventListener('submit', handleLogin);
            dom.registerForm.addEventListener('submit', handleRegister);
            dom.logoutButton.addEventListener('click', handleLogout);
            dom.syncButton.addEventListener('click', handleSync);
            dom.profileButton.addEventListener('click', openProfile);
            dom.closeProfileButton.addEventListener('click', closeProfile);
            dom.profileForm.addEventListener('submit', handleProfileUpdate);
            dom.showRegisterViewButton.addEventListener('click', showRegisterView);
            dom.showLoginViewButton.addEventListener('click', showLoginView);
            dom.toggleAllCatapults.addEventListener('change', handleToggleAllCatapults);
            dom.toggleUnclaimedNames.addEventListener('change', handleToggleUnclaimedNames);
            dom.resetViewButton.addEventListener('click', handleResetView);
            dom.centerMeButton.addEventListener('click', centerOnMyLocation);
            dom.menuButton.addEventListener('click', toggleSidePanel);
            
            dom.routeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const startVal = dom.startSystemInput.value.trim();
                const endVal = dom.endSystemInput.value.trim();
                const parseInput = (val) => {
                    if (val.startsWith('#')) { const pos = parseFloat(val.substring(1)); return !isNaN(pos) ? `pos:${pos}` : null; }
                    const system = Object.values(systems).find(s => s.name.toLowerCase() === val.toLowerCase() || `#${s.position}` === val);
                    return system ? `sys:${system.id}` : null;
                };
                const startId = parseInput(startVal);
                const endId = parseInput(endVal);
                if (startId && endId) { findPath(startId, endId); } 
                else { dom.routeDetailsContainer.innerHTML = `<p class="text-red-400">Could not find one or both locations. Please use a known system name or format coordinates as #123.45</p>`; }
            });
            dom.startSystemInput.addEventListener('focus', () => { activeRouteInput = dom.startSystemInput; });
            dom.endSystemInput.addEventListener('focus', () => { activeRouteInput = dom.endSystemInput; });
            document.addEventListener('click', (e) => { if (!dom.routeForm.contains(e.target) && !dom.canvas.contains(e.target)) { activeRouteInput = null; }});
            dom.routeDetailsContainer.addEventListener('click', (e) => { if (e.target && e.target.id === 'clear-route-button') { clearRouteDisplay(); } });

            dom.canvas.addEventListener('mousedown', onInteractionStart); dom.canvas.addEventListener('mousemove', onInteractionMove);
            dom.canvas.addEventListener('mouseup', onInteractionEnd); dom.canvas.addEventListener('mouseleave', onInteractionEnd);
            dom.canvas.addEventListener('wheel', (e) => { e.preventDefault(); const s=1.1, mX=e.clientX-dom.canvas.offsetLeft, mY=e.clientY-dom.canvas.offsetTop; const wX=(mX-viewTransform.translateX)/viewTransform.scale, wY=(mY-viewTransform.translateY)/viewTransform.scale; if(e.deltaY<0)viewTransform.scale*=s; else viewTransform.scale/=s; viewTransform.translateX=mX-wX*viewTransform.scale; viewTransform.translateY=mY-wY*viewTransform.scale; drawMap(); localStorage.setItem('mapViewTransform', JSON.stringify(viewTransform)); });
            
            dom.canvas.addEventListener('touchstart', onInteractionStart); dom.canvas.addEventListener('touchmove', onInteractionMove);
            dom.canvas.addEventListener('touchend', onInteractionEnd); dom.canvas.addEventListener('touchcancel', onInteractionEnd);
        }
        
        setupEventListeners();
        checkLoginStatus();
    });
    </script>
</body>
</html>