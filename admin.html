<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Galactic Star Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: 'Inter', sans-serif; }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 2.5rem;}
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="antialiased">
    <div class="container mx-auto p-8">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Admin Panel</h1>
            <a href="/" class="text-indigo-400 hover:text-indigo-300">&larr; Back to Main Map</a>
        </header>

        <div class="max-w-md mx-auto mb-8">
            <div class="bg-gray-900 rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold text-white mb-4">Promote Developer</h2>
                <form id="promote-dev-form" class="space-y-3">
                        <input type="text" id="dev-username-input" placeholder="Username to promote" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white">
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Promote to Developer</button>
                </form>
                <p id="dev-status" class="text-sm text-center text-green-400 mt-4 h-4"></p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-gray-900 rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold text-white mb-4">Faction Relationships</h2>
                <form id="add-relationship-form" class="mb-6 bg-gray-800 p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold text-white">Set Relationship</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="faction-a-select" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white"></select>
                        <select id="faction-b-select" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white"></select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <select id="status-select" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white">
                            <option value="allied">Allied</option>
                            <option value="war">War</option>
                        </select>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm">Set Status</button>
                    </div>
                </form>
                <div class="overflow-y-auto h-64">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-800 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Faction A</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Faction B</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Status</th>
                                <th class="relative px-6 py-3"><span class="sr-only">Delete</span></th>
                            </tr>
                        </thead>
                        <tbody id="relationships-table-body" class="bg-gray-800 divide-y divide-gray-700"></tbody>
                    </table>
                </div>
                 <p id="relationship-status" class="text-sm text-center text-green-400 mt-4 h-4"></p>
            </div>
            <div class="bg-gray-900 rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold text-white mb-4">Manage Wormholes</h2>
                <form id="add-wormhole-form" class="mb-6 bg-gray-800 p-4 rounded-lg space-y-3">
                    <h3 class="font-semibold text-white">Add New Wormhole</h3>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="wormhole-id-a" placeholder="System A ID" class="w-full bg-gray-700 border border-gray-600 rounded-md py-1 px-2 text-white">
                        <span class="text-gray-400">&harr;</span>
                        <input type="number" id="wormhole-id-b" placeholder="System B ID" class="w-full bg-gray-700 border border-gray-600 rounded-md py-1 px-2 text-white">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm">Add Wormhole</button>
                </form>
                <div class="overflow-y-auto h-80">
                    <table class="min-w-full divide-y divide-gray-700">
                         <thead class="bg-gray-800 sticky top-0"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">System A</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">System B</th><th class="relative px-6 py-3"><span class="sr-only">Delete</span></th></tr></thead>
                        <tbody id="wormholes-table-body" class="bg-gray-800 divide-y divide-gray-700"></tbody>
                    </table>
                </div>
                 <p id="wormhole-status" class="text-sm text-center text-green-400 mt-4 h-4"></p>
            </div>
        </div>
        <div class="bg-gray-900 rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold text-white mb-4">Manage Systems (Catapults & Ownership)</h2>
            <div class="mb-4"><input type="text" id="search-input" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="Search by System Name or ID..."></div>
            <div class="overflow-y-auto h-96">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">System</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Catapult Radius</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Owner Faction</th>
                            <th class="relative px-4 py-3"><span class="sr-only">Save</span></th>
                        </tr>
                    </thead>
                    <tbody id="systems-table-body" class="bg-gray-800 divide-y divide-gray-700"></tbody>
                </table>
            </div>
            <p id="system-status" class="text-sm text-center text-green-400 mt-4 h-4"></p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            systemsTableBody: document.getElementById('systems-table-body'), searchInput: document.getElementById('search-input'), systemStatus: document.getElementById('system-status'),
            wormholesTableBody: document.getElementById('wormholes-table-body'), addWormholeForm: document.getElementById('add-wormhole-form'), wormholeStatus: document.getElementById('wormhole-status'),
            relationshipsTableBody: document.getElementById('relationships-table-body'), addRelationshipForm: document.getElementById('add-relationship-form'), relationshipStatus: document.getElementById('relationship-status'),
            factionASelect: document.getElementById('faction-a-select'), factionBSelect: document.getElementById('faction-b-select'),
            promoteDevForm: document.getElementById('promote-dev-form'), devStatus: document.getElementById('dev-status')
        };
        let allSystems = []; let allFactions = [];

        const apiFetch = (url, options = {}) => { options.credentials = 'include'; return fetch(url, options); };
        
        const renderSystemsTable = (systems) => {
            dom.systemsTableBody.innerHTML = '';
            systems.forEach(system => {
                const row = document.createElement('tr');
                row.dataset.systemId = system.id;
                
                // --- FIX IS HERE ---
                // Check if the name is a default "System xxxx" name
                const displayName = system.name.startsWith("System ") ? `#${system.position}` : system.name;
                const nameColor = system.name.startsWith("System ") ? "text-gray-400" : "text-white";
                
                const ownerSelect = `<select class="w-full bg-gray-700 rounded-md py-1 px-2 text-white owner-select"><option value="0">None</option>${allFactions.map(f => `<option value="${f.id}" ${system.owner_faction_id === f.id ? 'selected' : ''}>${f.name}</option>`).join('')}</select>`;
                
                row.innerHTML = `
                    <td class="px-4 py-4 text-sm">
                        <div class="font-medium ${nameColor}">${displayName}</div>
                        <div class="text-gray-400">${system.id}</div>
                    </td>
                    <td class="px-4 py-4"><input type="number" value="${system.catapult_radius}" class="w-24 bg-gray-700 rounded-md py-1 px-2 text-white radius-input"></td>
                    <td class="px-4 py-4">${ownerSelect}</td>
                    <td class="px-4 py-4 text-right"><button class="text-indigo-400 hover:text-indigo-300 save-btn">Save</button></td>`;
                
                dom.systemsTableBody.appendChild(row);
            });
        };
        
        const renderWormholesTable = (wormholes) => {
            dom.wormholesTableBody.innerHTML = '';
            wormholes.forEach(wh => {
                const row = document.createElement('tr'); row.dataset.idA = wh.system_a_id; row.dataset.idB = wh.system_b_id;
                row.innerHTML = `<td class="px-6 py-4 text-sm text-gray-300">${wh.name_a} (${wh.system_a_id})</td><td class="px-6 py-4 text-sm text-gray-300">${wh.name_b} (${wh.system_b_id})</td><td class="px-6 py-4 text-right"><button class="text-red-400 hover:text-red-300 delete-btn">&times;</button></td>`;
                dom.wormholesTableBody.appendChild(row);
            });
        };

        const renderRelationshipsTable = (relationships) => {
            dom.relationshipsTableBody.innerHTML = '';
            relationships.forEach(rel => {
                const row = document.createElement('tr');
                row.dataset.idA = rel.faction_a_id; row.dataset.idB = rel.faction_b_id;
                const statusColor = rel.status === 'allied' ? 'text-green-400' : 'text-red-400';
                row.innerHTML = `<td class="px-6 py-4 text-sm text-gray-300">${rel.name_a}</td><td class="px-6 py-4 text-sm text-gray-300">${rel.name_b}</td><td class="px-6 py-4 text-sm font-semibold ${statusColor}">${rel.status.toUpperCase()}</td><td class="px-6 py-4 text-right"><button class="text-red-400 hover:text-red-300 delete-rel-btn">&times;</button></td>`;
                dom.relationshipsTableBody.appendChild(row);
            });
        };
        
        const handleSaveSystem = async (e) => {
            if (!e.target.classList.contains('save-btn')) return;
            const row = e.target.closest('tr');
            const systemId = row.dataset.systemId;
            const newRadius = parseFloat(row.querySelector('.radius-input').value);
            const ownerId = row.querySelector('.owner-select').value;
            dom.systemStatus.textContent = `Saving System ${systemId}...`;
            
            const radiusPromise = apiFetch('/api/admin/update_system', {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ system_id: systemId, catapult_radius: newRadius })});
            const ownerPromise = apiFetch('/api/admin/update_system_owner', {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ system_id: systemId, owner_faction_id: ownerId })});
            
            await Promise.all([radiusPromise, ownerPromise]);
            dom.systemStatus.textContent = `System ${systemId} saved successfully.`;
            setTimeout(() => { dom.systemStatus.textContent = '' }, 3000);
        };

        const handleAddWormhole = async (e) => { e.preventDefault(); const idA = parseInt(document.getElementById('wormhole-id-a').value, 10); const idB = parseInt(document.getElementById('wormhole-id-b').value, 10); if (!idA || !idB || idA === idB) { dom.wormholeStatus.textContent = 'Invalid system IDs.'; return; } dom.wormholeStatus.textContent = 'Adding...'; const r = await apiFetch('/api/admin/add_wormhole', {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ system_a_id: idA, system_b_id: idB })}); const d = await r.json(); dom.wormholeStatus.textContent = d.message || d.error; if(r.ok) loadAdminData(); dom.addWormholeForm.reset(); setTimeout(() => { dom.wormholeStatus.textContent = '' }, 3000); };
        const handleDeleteWormhole = async (e) => { if (!e.target.classList.contains('delete-btn')) return; if (!confirm('Are you sure?')) return; const row = e.target.closest('tr'); const { idA, idB } = row.dataset; dom.wormholeStatus.textContent = 'Deleting...'; const r = await apiFetch('/api/admin/delete_wormhole', {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ system_a_id: idA, system_b_id: idB })}); const d = await r.json(); dom.wormholeStatus.textContent = d.message; if (r.ok) row.remove(); setTimeout(() => { dom.wormholeStatus.textContent = '' }, 3000); };
        
        const handleAddRelationship = async (e) => {
            e.preventDefault();
            const idA = parseInt(dom.factionASelect.value, 10);
            const idB = parseInt(dom.factionBSelect.value, 10);
            const status = document.getElementById('status-select').value;
            if (!idA || !idB || idA === idB) { dom.relationshipStatus.textContent = 'Please select two different factions.'; return; }
            dom.relationshipStatus.textContent = 'Setting relationship...';
            const r = await apiFetch('/api/admin/add_relationship', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ faction_a_id: idA, faction_b_id: idB, status: status }) });
            const d = await r.json(); dom.relationshipStatus.textContent = d.message || d.error;
            if (r.ok) { loadAdminData(); }
            setTimeout(() => { dom.relationshipStatus.textContent = '' }, 3000);
        };

        const handleDeleteRelationship = async (e) => {
            if (!e.target.classList.contains('delete-rel-btn')) return;
            if (!confirm('Are you sure you want to delete this relationship?')) return;
            const row = e.target.closest('tr'); const { idA, idB } = row.dataset;
            dom.relationshipStatus.textContent = 'Deleting...';
            const r = await apiFetch('/api/admin/delete_relationship', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ faction_a_id: idA, system_b_id: idB }) });
            const d = await r.json(); dom.relationshipStatus.textContent = d.message;
            if (r.ok) row.remove();
            setTimeout(() => { dom.relationshipStatus.textContent = '' }, 3000);
        };

        const handlePromoteDeveloper = async (e) => {
            e.preventDefault();
            const username = document.getElementById('dev-username-input').value.trim();
            if (!username) { dom.devStatus.textContent = 'Please enter a username.'; return; }
            dom.devStatus.textContent = 'Promoting...';
            try {
                const r = await apiFetch('/api/admin/promote_developer', {method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: username })});
                const d = await r.json(); dom.devStatus.textContent = d.message || d.error;
                if(r.ok) dom.promoteDevForm.reset();
            } catch(err) {
                 dom.devStatus.textContent = 'Error: Endpoint not found.';
            }
            setTimeout(() => { dom.devStatus.textContent = '' }, 3000);
        };

        const handleSearch = (e) => { const query = e.target.value.toLowerCase(); const filtered = allSystems.filter(s => String(s.id).includes(query) || s.name.toLowerCase().includes(query) || (s.name.startsWith("System ") && `#${s.position}`.includes(query)) ); renderSystemsTable(filtered); };
        
        const loadAdminData = async () => {
            try {
                const [systemsRes, wormholesRes, factionsRes, relsRes] = await Promise.all([
                    apiFetch('/api/admin/systems'), apiFetch('/api/admin/wormholes'), apiFetch('/api/admin/factions'), apiFetch('/api/admin/relationships')
                ]);
                if (systemsRes.status === 403) { document.body.innerHTML = '<div class="text-center p-8 text-red-400">Admin access required. <a href="/" class="text-indigo-400">Go back</a></div>'; return; }
                
                allSystems = await systemsRes.json();
                allFactions = await factionsRes.json();
                const allWormholes = await wormholesRes.json();
                const allRelationships = await relsRes.json();
                
                const factionOptions = allFactions.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
                dom.factionASelect.innerHTML = factionOptions;
                dom.factionBSelect.innerHTML = factionOptions;

                renderSystemsTable(allSystems);
                renderWormholesTable(allWormholes);
                renderRelationshipsTable(allRelationships);

            } catch (error) { console.error("Failed to load admin data:", error); }
        };
        
        dom.systemsTableBody.addEventListener('click', handleSaveSystem);
        dom.wormholesTableBody.addEventListener('click', handleDeleteWormhole);
        dom.relationshipsTableBody.addEventListener('click', handleDeleteRelationship);
        dom.addWormholeForm.addEventListener('submit', handleAddWormhole);
        dom.addRelationshipForm.addEventListener('submit', handleAddRelationship);
        dom.promoteDevForm.addEventListener('submit', handlePromoteDeveloper);
        dom.searchInput.addEventListener('input', handleSearch);
        
        loadAdminData();
    });
    </script>
</body>
</html>